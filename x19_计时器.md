> å¦‚ä½•åˆç†çš„è®¾ç½®è®¡æ—¶å™¨ï¼šä¸åŒè®¡æ—¶å™¨æ–¹æ³•çš„åŒºåˆ«ã€ä¸»çº¿ç¨‹å’Œéä¸»çº¿ç¨‹çš„åŒºåˆ«
>
> è®¡æ—¶å™¨ä¸å½¢æˆå¾ªç¯å¼•ç”¨ï¼š**å°†å®šæ—¶å™¨çš„targetå¯¹è±¡ä¸è®¾ç½®ä¸ºå½“å‰æ§åˆ¶å™¨**

---

### è®¡æ—¶å™¨

åœ¨iOSå¼€å‘ä¸­è¦å®ç°ä¸€ä¸ªè®¡æ—¶å™¨ï¼Œå¯ä»¥ä½¿ç”¨`NSTimer`å’Œ`CADisplayLink`è¿™ä¸¤ä¸ªç±»ï¼Œä»¥åŠåŸºäº`GCDçš„è®¡æ—¶å™¨é˜Ÿåˆ—`ã€‚NSTimerå¯ä»¥è®¾ç½®è®¡æ—¶å™¨çš„é—´éš”ï¼ŒCADisplayLinkä¸å¯ä»¥è®¾ç½®é—´éš”ï¼Œå¹¶ä¸”ä¸¤è€…éƒ½å¯ä»¥åŠ å…¥åˆ°runloopä¸­ã€‚



### NSTimer

ç›¸å¯¹äºCADisplayLinkå•ä¸€çš„åˆå§‹åŒ–æ–¹æ³•ï¼ŒNSTimeræœ‰å¤šä¸ªåˆå§‹åŒ–è®¡æ—¶å™¨çš„æ–¹æ³•ï¼š

```objective-c
+ (NSTimer *)timerWithTimeInterval:(NSTimeInterval)ti invocation:(NSInvocation *)invocation repeats:(BOOL)yesOrNo;

+ (NSTimer *)timerWithTimeInterval:(NSTimeInterval)ti target:(id)aTarget selector:(SEL)aSelector userInfo:(nullable id)userInfo repeats:(BOOL)yesOrNo

+ (NSTimer *)timerWithTimeInterval:(NSTimeInterval)interval repeats:(BOOL)repeats block:(void (^)(NSTimer *timer))block ;

+ (NSTimer *)scheduledTimerWithTimeInterval:(NSTimeInterval)ti invocation:(NSInvocation *)invocation repeats:(BOOL)yesOrNo;

+ (NSTimer *)scheduledTimerWithTimeInterval:(NSTimeInterval)interval repeats:(BOOL)repeats block:(void (^)(NSTimer *timer))block ;

+ (NSTimer *)scheduledTimerWithTimeInterval:(NSTimeInterval)ti target:(id)aTarget selector:(SEL)aSelector userInfo:(nullable id)userInfo repeats:(BOOL)yesOrNo;
```

è¿™äº›æ–¹æ³•åˆå¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š`+timerWithâ€¦`ã€`+scheduledTimerWith...`ã€‚

äºŒè€…æœ€å¤§çš„åŒºåˆ«å°±æ˜¯åè€…ï¼ˆ+scheduledTimerWith...ï¼‰é™¤äº†åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨å¤–ï¼Œè¿˜ä¼šè‡ªåŠ¨å°†å®šæ—¶å™¨ä»¥`NSDefaultRunLoopModeMode`æ¨¡å¼æ·»åŠ åˆ°å½“å‰çº¿ç¨‹çš„RunLoopä¸­ã€‚ä¸æ·»åŠ åˆ°RunLoopä¸­çš„NSTimeræ˜¯æ— æ³•æ­£å¸¸å·¥ä½œçš„ï¼š

```objective-c
self.timer1 = [NSTimer timerWithTimeInterval:1 repeats:YES block:^(NSTimer * _Nonnull timer) {
        NSLog(@"timer1");
    }];
//    [[NSRunLoop currentRunLoop] addTimer:self.timer1 forMode:NSDefaultRunLoopMode];
// ğŸ‘†è¿™ä¸€æ®µåŠ å…¥runloopçš„ä»£ç å¦‚æœä¸æ‰“å¼€ï¼Œtimer1æ°¸è¿œä¸ä¼šè¿›è¡Œå¯¹åº”çš„è®¡æ—¶å™¨æ“ä½œ
    
self.timer2 = [NSTimer scheduledTimerWithTimeInterval:1 target:self selector:@selector(log) userInfo:nil repeats:YES];
```



### å¾ªç¯å¼•ç”¨

ä¸Šé¢çš„timer2æ˜¯ä½¿ç”¨çš„strongä¿®é¥°çš„ï¼Œå¦‚æœä½¿ç”¨weakä¿®é¥°ï¼Œä¹Ÿä¼šå¼•èµ·å¾ªç¯å¼•ç”¨ï¼Œä¸ºäº†ç¡®ä¿å®šæ—¶å™¨æ­£å¸¸è¿è½¬ï¼Œå½“åŠ å…¥åˆ°RunLoopä»¥åç³»ç»Ÿä¼šå¯¹NSTimeræ‰§è¡Œä¸€æ¬¡retainæ“ä½œï¼Œè¿™æ˜¯ç”±äºåˆ›å»ºNSTimer2æ—¶æŒ‡å®šäº†targetä¸ºselfï¼Œå¾ªç¯å¼•ç”¨çš„æ¡ä»¶å½¢æˆã€‚å› æ­¤ï¼Œç›´åˆ°timer2æ‰§è¡Œäº†`invalidate`æ–¹æ³•ï¼Œä¸¤è€…æ‰å¯ä»¥å®‰å…¨é‡Šæ”¾ã€‚

å‡å¦‚åœ¨ä¸€ä¸ªæ§åˆ¶å™¨ä¸­æœ‰ä¸€ä¸ªCADisplayLinkè®¡æ—¶å™¨ï¼Œå¹¶å°†è®¡æ—¶å™¨åŠ å…¥åˆ°runloopä¸­ï¼š

```objective-c
- (void)dealloc{
    [_link removeFromRunLoop:[NSRunLoop currentRunLoop]
                     forMode:NSRunLoopCommonModes];
    [_link invalidate];
    NSLog(@"ProxyViewController dealloc");
}
- (void)viewDidLoad {
    [super viewDidLoad];
    _link = [CADisplayLink displayLinkWithTarget:self selector:@selector(log)];
    [_link addToRunLoop:[NSRunLoop currentRunLoop] forMode:NSRunLoopCommonModes];
}
```

è¿™æ ·å°±å½¢æˆäº†:_linké€šè¿‡`displayLinkWithTarget:`æ–¹æ³•å¯¹selfè¿›è¡Œå¼ºå¼•ç”¨ï¼Œselfé€šè¿‡å±æ€§å¯¹ _linkè¿›è¡Œå¼ºå¼•ç”¨çš„ä¸€ä¸ªå¾ªç¯å¼•ç”¨ã€‚ç»“æœå°±æ˜¯selfçš„deallocæ–¹æ³•æ°¸è¿œä¸ä¼šèµ°ï¼Œè®¡æ—¶å™¨çš„logæ–¹æ³•ä¼šä¸€ç›´è¿›è¡Œè¾“å‡ºã€‚

å¦‚æœæ›¿æ¢selfæ”¹ä¸ºä½¿ç”¨weakSelfæ¥è®¾ç½®ä¸ºå®šæ—¶å™¨çš„targetï¼Œä¼šæ€ä¹ˆæ ·å‘¢ï¼š

```objective-c
    __weak typeof(self) weakSelf = self;
    _link = [CADisplayLink displayLinkWithTarget:weakSelf selector:@selector(log)];
    [_link addToRunLoop:[NSRunLoop currentRunLoop] forMode:NSRunLoopCommonModes];
```

ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œdeallocä¸ä¼šèµ°ï¼Œå®šæ—¶å™¨logä¸€ç›´åœ¨è¾“å‡ºï¼Œçœ‹æ¥weakSelfå¹¶æ²¡æœ‰è§£å†³å¾ªç¯å¼•ç”¨çš„é—®é¢˜ï¼Œå³ä½¿è®¾ç½®å±æ€§çš„æ—¶å€™ä½¿ç”¨weakæ¥ä¿®é¥°linkä¹Ÿæ˜¯ä¸€æ ·çš„ç»“æœã€‚

è¿™æ ·çš„ç»“æœä¸ä»…é™äºCADisplayLinkï¼Œä½¿ç”¨NSTimerä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚



### éä¸»çº¿ç¨‹è®¡æ—¶å™¨

ä¸€èˆ¬åˆ›å»ºçš„è®¡æ—¶å™¨å¯¹è±¡éƒ½æ˜¯åœ¨main-threadä¸­ï¼Œå¦‚æœæœ‰éœ€æ±‚è¦åœ¨éä¸»çº¿ç¨‹ä¸­åˆ›å»ºè®¡æ—¶å™¨ï¼Œå¯ä»¥æŒ‰ç…§ä¸‹é¢çš„æ–¹å¼ï¼š

```objective-c
- (void) viewDidLoad{
  //...
    self.thread1 = [[NSThread alloc] initWithTarget:self selector:@selector(performTask) object:nil];
    [self.thread1 start];
}

// émain-threadä¸­
- (void)performTask {
    self.timer1 = [NSTimer scheduledTimerWithTimeInterval:1.0 repeats:YES block:^(NSTimer * _Nonnull timer) {
       //if ([NSThread currentThread].isCancelled) {
       //     [weakSelf.timer1 invalidate];
       //}
        NSLog(@"timer1...");
    }];
    
    // éä¸»çº¿ç¨‹RunLoopå¿…é¡»æ‰‹åŠ¨è°ƒç”¨ run ,å½“å‰çº¿ç¨‹ä¸ºï¼šself.thread1
    [[NSRunLoop currentRunLoop] run];
    
    // è¿™ä¸ªlogåªæœ‰åœ¨å½“å‰çº¿ç¨‹çš„runloopæ‰§è¡Œå®Œæˆä¹‹åæ‰ä¼šè¿›è¡Œæ‰“å°ï¼Œè¿™å°±æ˜¯è¯´ï¼Œrunloopå°±æ˜¯ä¸€ä¸ªdo-whileå¾ªç¯
    NSLog(@"æ³¨æ„ï¼šå¦‚æœRunLoopä¸é€€å‡ºï¼ˆè¿è¡Œä¸­ï¼‰ï¼Œè¿™é‡Œçš„ä»£ç å¹¶ä¸ä¼šæ‰§è¡Œï¼ŒRunLoopæœ¬èº«å°±æ˜¯ä¸€ä¸ªå¾ªç¯");
}

```

ä»ä¸Šé¢å¯ä»¥çŸ¥é“`+ScheduledTimerWith...`çš„è®¡æ—¶å™¨ä¼šè‡ªåŠ¨åŠ å…¥åˆ°å½“å‰runLoopä¸­ï¼Œä½†æ˜¯**é™¤äº†ä¸»çº¿ç¨‹å¤–å…¶ä»–çº¿ç¨‹çš„RunLoopé»˜è®¤æ˜¯ä¸ä¼šè¿è¡Œçš„**ï¼Œå¿…é¡»æ‰‹åŠ¨è°ƒç”¨runæ‰å¯ä»¥å°†å…¶åŠ å…¥runLoopã€‚å› æ­¤æ‰æœ‰äº†åé¢çš„`[[NSRunLoop currentRunLoop] run];`ä»£ç ï¼Œä½†æ˜¯ä¸€æ—¦æ‰§è¡Œäº†runLoopä¹‹åï¼Œä»–åé¢çš„æ“ä½œéƒ½å°†åœ¨è¿™ä¸ªrunLoopç»“æŸä¹‹åæ‰ä¼šæ‰§è¡Œã€‚

æ·»åŠ ä¸€ä¸ªå–æ¶ˆçº¿ç¨‹çš„æ“ä½œï¼Œè®©çº¿ç¨‹å¯¹åº”çš„runloopåœæ­¢ï¼Œå¹¶æ‰“å¼€è®¡æ—¶å™¨blockä¸­æ³¨é‡Šæ‰çš„è¯­å¥ï¼Œå°±å¯ä»¥æ‰“å°æœ€åçš„é‚£ä¸€ä¸ªlogï¼š

```objective-c
- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event {
    [self.thread1 cancel];
}
```



### åˆ†ç¦»target

è¦è§£å†³ç”±è®¡æ—¶å™¨å¼•èµ·çš„å¾ªç¯å¼•ç”¨é—®é¢˜ï¼Œæ ¸å¿ƒæ“ä½œæ˜¯ï¼š**å°†å®šæ—¶å™¨çš„targetå¯¹è±¡ä¸è®¾ç½®ä¸ºå½“å‰æ§åˆ¶å™¨**ï¼ˆæˆ–è€…å…¶ä»–å¯¹å®šæ—¶å™¨è¿›è¡ŒæŒæœ‰çš„ç±»ï¼Œè¿™é‡Œä¹˜æ¥ä¸Šé¢çš„ä¾‹å­ï¼Œè®¤ä¸ºæ˜¯æ§åˆ¶å™¨ï¼‰ã€‚

å…·ä½“æœ‰ä¸¤ç§æ–¹æ³•ï¼š

* å°†targetåˆ†ç¦»å‡ºæ¥ç‹¬ç«‹æˆä¸€ä¸ªå¯¹è±¡ã€‚è¿™ä¸ªå¯¹è±¡ä½œä¸ºè®¡æ—¶å™¨çš„targetï¼Œæ§åˆ¶å™¨é€šè¿‡è¿™ä¸ªå¯¹è±¡é—´æ¥ä½¿ç”¨è®¡æ—¶å™¨ï¼Œè¿™å°±æ˜¯[YYWeakProxy](https://github.com/ibireme/YYKit/blob/master/YYKit/Utility/YYWeakProxy.h)çš„å®ç°æ€è·¯

  ```objective-c
  _link = [CADisplayLink displayLinkWithTarget:[YYWeakProxy proxyWithTarget:self] selector:@selector(log)];
  [_link addToRunLoop:[NSRunLoop currentRunLoop] forMode:NSRunLoopCommonModes];
  ```

* è®©è®¡æ—¶å™¨è‡ªå·±ä½œä¸ºè‡ªå·±çš„targetã€‚å¢åŠ è®¡æ—¶å™¨ç±»çš„æ‹“å±•ï¼ˆåˆ†ç±»ï¼‰ï¼Œè®©è®¡æ—¶å™¨è‡ªèº«åšä¸ºtargetï¼ŒåŒæ—¶å¯ä»¥å°†æ“ä½œselectorå°è£…åˆ°blockä¸­ï¼Œè¿™æ˜¯[NSTimer+Block](https://github.com/mBrissman/NSTimer-Block)çš„å®ç°æ€è·¯

  ```objective-c
  self.timer1 = [NSTimer scheduledTimerWithTimeInterval:1.0 repeats:YES block:^(NSTimer * _Nonnull timer) {
      NSLog(@"timer1...");
  }];
  ```

  ä¸è¿‡åœ¨iOS10.0ä¹‹åï¼Œç³»ç»Ÿä¸ºNSTimerå¢åŠ äº†blockçš„æ“ä½œï¼Œè§£å†³äº†å¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚ä¸è¿‡ï¼Œè™½ç„¶æ§åˆ¶å™¨å¯ä»¥å®‰å…¨æ‰§è¡Œdeallocæ–¹æ³•è¿›è¡Œé‡Šæ”¾ï¼Œè®¡æ—¶å™¨çš„logæ–¹æ³•è¿˜æ˜¯ç»§ç»­åœ¨è¿›è¡Œï¼Œè¿™ä¸ªå°±éœ€è¦åœ¨deallocä¸­å¯¹è®¡æ—¶å™¨æ‰§è¡Œ`invalidate`æ–¹æ³•æ¥åœæ­¢è®¡æ—¶å™¨ã€‚


---

https://www.cnblogs.com/kenshincui/p/6823841.html